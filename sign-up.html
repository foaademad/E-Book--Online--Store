<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up - BookHaven</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css"
    integrity="sha512-k+xZuzf4IaGQK9sSDjaNyrfwgxBfoF++7u6Q0ZVUs2rDczx9doNZkYXyyQbnJQcMR4o+IjvAcIj69hHxiOZEig=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="src/css/auth.css" />
  <link rel="stylesheet" href="src/css/variables.css" />
  <link rel="stylesheet" href="src/css/global.css" />
</head>

<body>
  <div class="auth-container">
    <div class="container">
      <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-5">
          <div class="auth-card">
            <!-- Logo and Title -->
            <div class="text-center mb-4">

              <h4 class="auth-title">Sign up to BookHaven</h4>
            </div>

            <!-- Social Login -->
            <div class="social-buttons">
              <button class="social-btn">
                <img src="src/images/facebook.svg" alt="Facebook" />
              </button>
              <button class="social-btn">
                <img src="src/images/google.svg" alt="Google" />
              </button>
              <button class="social-btn">
                <img src="src/images/apple.svg" alt="Apple" />
              </button>
            </div>

            <div class="divider">
              <span>or do via email</span>
            </div>

            <!-- Signup Form -->
            <form class="auth-form" id="signupForm" novalidate>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="firstName" placeholder="First Name" required />
                    <label for="firstName">First Name</label>
                    <div class="invalid-feedback">Please enter your first name</div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="lastName" placeholder="Last Name" required />
                    <label for="lastName">Last Name</label>
                    <div class="invalid-feedback">Please enter your last name</div>
                  </div>
                </div>
              </div>

              <div class="form-floating mb-3">
                <input type="date" class="form-control" id="birthday" placeholder="Birthday" required />
                <label for="birthday">Birthday</label>
                <div class="invalid-feedback">Please select your birthday</div>
              </div>

              <div class="form-floating mb-3">
                <select class="form-select" id="gender" aria-label="Gender" required>
                  <option selected disabled value="">Select gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
                <label for="gender">Gender</label>
                <div class="invalid-feedback">Please select your gender</div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="email" placeholder="name@example.com" required />
                    <label for="email">Email address</label>
                    <div class="invalid-feedback">Please enter a valid email address</div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="tel" class="form-control" id="phone" placeholder="Phone Number" required />
                    <label for="phone">Phone Number</label>
                    <div class="invalid-feedback">Please enter a valid phone number</div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="password-field form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="Password" required />
                    <label for="password">Password</label>
                    <button type="button" class="password-toggle">
                      <i class="far fa-eye"></i>
                    </button>
                    <div class="invalid-feedback">Password must be at least 8 characters and contain at least 1
                      uppercase letter, lowercase letter, number, and special
                      character
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="password-field form-floating mb-3">
                    <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm Password"
                      required />
                    <label for="confirmPassword">Confirm Password</label>
                    <button type="button" class="password-toggle">
                      <i class="far fa-eye"></i>
                    </button>
                    <div class="invalid-feedback">Passwords do not match</div>
                  </div>
                </div>
              </div>

              <div class="form-floating mb-3">
                <select class="form-select" id="role" aria-label="Role" required>
                  <option selected disabled value="">Select role</option>
                  <option value="client">Customer</option>
                  <option value="seller">Seller</option>
                </select>
                <label for="role">Role</label>
                <div class="invalid-feedback">Please select a role</div>
              </div>

              <button type="submit" class="btn btn-auth w-100">
                Sign up
              </button>
            </form>

            <div class="text-center mt-4">
              <p class="auth-link">
                Have an account? <a href="sign-in.html">Sign in</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"
    integrity="sha512-0Yc4Jv5wX4+mjDuLxmHFGqgDtMFAEBLpPq/0nPVmAOwHPMkYXiS1YVYWTcrVQztftk/32089DDTyrCJO8hBCZw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    $(document).ready(function () {
  // Retrieve users from localStorage or initialize an empty array
  const usersStorage = localStorage.getItem("users");
  let users;

  try {
    users = usersStorage ? JSON.parse(usersStorage) : [];
    if (!Array.isArray(users)) throw new Error("Users data is not an array.");
  } catch (error) {
    console.error("Error initializing users data:", error);
    users = [];
    localStorage.setItem("users", JSON.stringify(users)); 
  }

  
  const isEmailExists = (email) => users.find((user) => user.email === email);

  
  const isPhoneExists = (phone) => users.find((user) => user.phone === phone);

  
  $('.password-toggle').click(function () {
    const input = $(this).closest('.password-field').find('input');
    const icon = $(this).find('i');

    if (input.attr('type') === 'password') {
      input.attr('type', 'text');
      icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
      input.attr('type', 'password');
      icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
  });

  // Individual field validation functions
  function validateFirstName() {
    const firstNameInput = $('#firstName');
    const nameRegex = /^[A-Za-z]+$/;
    const firstName = firstNameInput.val();

    if (!firstName) {
      firstNameInput.addClass('is-invalid');
      firstNameInput.siblings('.invalid-feedback').text('First name is required');
      return false;
    } else if (firstName.length < 5) {
      firstNameInput.addClass('is-invalid');
      firstNameInput.siblings('.invalid-feedback').text('First name must be at least 5 characters');
      return false;
    } else if (!nameRegex.test(firstName)) {
      firstNameInput.addClass('is-invalid');
      firstNameInput.siblings('.invalid-feedback').text('First name must contain only letters');
      return false;
    }
    firstNameInput.removeClass('is-invalid');
    return true;
  }

  function validateLastName() {
    const lastNameInput = $('#lastName');
    const nameRegex = /^[A-Za-z]+$/;
    const lastName = lastNameInput.val();

    if (!lastName) {
      lastNameInput.addClass('is-invalid');
      lastNameInput.siblings('.invalid-feedback').text('Last name is required');
      return false;
    } else if (lastName.length < 5) {
      lastNameInput.addClass('is-invalid');
      lastNameInput.siblings('.invalid-feedback').text('Last name must be at least 5 characters');
      return false;
    } else if (!nameRegex.test(lastName)) {
      lastNameInput.addClass('is-invalid');
      lastNameInput.siblings('.invalid-feedback').text('Last name must contain only letters');
      return false;
    }
    lastNameInput.removeClass('is-invalid');
    return true;
  }

  function validateBirthday() {
    const birthdayInput = $('#birthday');
    const birthday = new Date(birthdayInput.val());
    const today = new Date();
    const tenYearsAgo = new Date();
    tenYearsAgo.setFullYear(today.getFullYear() - 10);

    if (!birthdayInput.val()) {
      birthdayInput.addClass('is-invalid');
      birthdayInput.siblings('.invalid-feedback').text('Birthday is required');
      return false;
    } else if (birthday > tenYearsAgo) {
      birthdayInput.addClass('is-invalid');
      birthdayInput.siblings('.invalid-feedback').text('You must be at least 10 years old');
      return false;
    }
    birthdayInput.removeClass('is-invalid');
    return true;
  }

  function validateGender() {
    const genderInput = $('#gender');
    if (!genderInput.val()) {
      genderInput.addClass('is-invalid');
      return false;
    }
    genderInput.removeClass('is-invalid');
    return true;
  }

  function validateEmail() {
    const emailInput = $('#email');
    const allowedDomains = ['gmail.com', 'yahoo.com', 'proton.me', 'outlook.com', 'hotmail.com'];
    const email = emailInput.val();

    if (!email) {
      emailInput.addClass('is-invalid');
      emailInput.siblings('.invalid-feedback').text('Email is required');
      return false;
    }

    const emailDomain = email.split('@')[1];
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!emailRegex.test(email)) {
      emailInput.addClass('is-invalid');
      emailInput.siblings('.invalid-feedback').text('Please enter a valid email address');
      return false;
    } else if (!allowedDomains.includes(emailDomain)) {
      emailInput.addClass('is-invalid');
      emailInput.siblings('.invalid-feedback').text('Please use a valid email provider (Gmail, Yahoo, Proton, Outlook, or Hotmail)');
      return false;
    } else if (isEmailExists(email)) {
      emailInput.addClass('is-invalid');
      emailInput.siblings('.invalid-feedback').text('This email is already registered');
      return false;
    }
    emailInput.removeClass('is-invalid');
    return true;
  }

  function validatePhone() {
    const phoneInput = $('#phone');
    const egyptPhoneRegex = /^(01)[0-2,5]{1}[0-9]{8}$/;
    const phoneNumber = phoneInput.val().replace(/\D/g, '');

    if (!phoneNumber) {
      phoneInput.addClass('is-invalid');
      phoneInput.siblings('.invalid-feedback').text('Phone number is required');
      return false;
    } else if (!egyptPhoneRegex.test(phoneNumber)) {
      phoneInput.addClass('is-invalid');
      phoneInput.siblings('.invalid-feedback').text('Please enter a valid Egyptian phone number (e.g., 01xxxxxxxxx)');
      return false;
    } else if (isPhoneExists(phoneNumber)) {
      phoneInput.addClass('is-invalid');
      phoneInput.siblings('.invalid-feedback').text('This phone number is already registered');
      return false;
    }
    phoneInput.removeClass('is-invalid');
    return true;
  }

  function validatePassword() {
    const passwordInput = $('#password');
    const password = passwordInput.val();

    if (!password) {
      passwordInput.addClass('is-invalid');
      passwordInput.siblings('.invalid-feedback').text('Password is required');
      return false;
    }

    const hasMinLength = password.length >= 8;
    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumbers = /\d/.test(password);
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

    if (!hasMinLength || !hasUpperCase || !hasLowerCase || !hasNumbers || !hasSpecialChar) {
      passwordInput.addClass('is-invalid');
      passwordInput.siblings('.invalid-feedback').text('Password must be at least 8 characters and contain at least 1 uppercase letter, lowercase letter, number, and special character');
      return false;
    }
    passwordInput.removeClass('is-invalid');
    return true;
  }

  function validateConfirmPassword() {
    const confirmInput = $('#confirmPassword');
    const password = $('#password').val();
    const confirm = confirmInput.val();

    if (!confirm) {
      confirmInput.addClass('is-invalid');
      confirmInput.siblings('.invalid-feedback').text('Confirm password is required');
      return false;
    } else if (password !== confirm) {
      confirmInput.addClass('is-invalid');
      return false;
    }
    confirmInput.removeClass('is-invalid');
    return true;
  }

  function validateRole() {
    const roleInput = $('#role');
    if (!roleInput.val()) {
      roleInput.addClass('is-invalid');
      return false;
    }
    roleInput.removeClass('is-invalid');
    return true;
  }

  // Form submission
  $('#signupForm').on('submit', function (e) {
    e.preventDefault();

    // Trigger all validations
    validateFirstName();
    validateLastName();
    validateBirthday();
    validateGender();
    validateEmail();
    validatePhone();
    validatePassword();
    validateConfirmPassword();
    validateRole();

    const isValid = validateFirstName() &&
      validateLastName() &&
      validateBirthday() &&
      validateGender() &&
      validateEmail() &&
      validatePhone() &&
      validatePassword() &&
      validateConfirmPassword() &&
      validateRole();

    if (isValid) {
      // Collect form data
      const formData = {
        firstName: $('#firstName').val(),
        lastName: $('#lastName').val(),
        birthday: $('#birthday').val(),
        gender: $('#gender').val(),
        email: $('#email').val(),
        phone: $('#phone').val().replace(/\D/g, ''),
        password: $('#password').val(),
        role: $('#role').val(),
        cart: [],
        history: [],
        bill: [],
        customerServiceMessages: [],
      };

      users.push(formData);
      localStorage.setItem("users", JSON.stringify(users));
      
      Toastify({
        text: "Your account has been created successfully.",
        duration: 3000,
        gravity: "top",
        position: "center",
        style: {
          background: "#198754",
        }, callback: function () {
          window.location.href = "sign-in.html";
        }
      }).showToast();
    }
  });

  // Validate individual fields on input
  $('#firstName').on('input', validateFirstName);
  $('#lastName').on('input', validateLastName);
  $('#birthday').on('change', validateBirthday);
  $('#gender').on('change', validateGender);
  $('#email').on('input', validateEmail);
  $('#phone').on('input', validatePhone);
  $('#password').on('input', function () {
    validatePassword();
    validateConfirmPassword();
  });
  $('#confirmPassword').on('input', validateConfirmPassword);
  $('#role').on('change', validateRole);
});
  </script>
</body>

</html>